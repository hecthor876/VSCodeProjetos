<script>
  const pokedexContainer = document.getElementById('pokedex');
  const searchInput = document.getElementById('searchInput');
  const typeFilter = document.getElementById('typeFilter');
  let allPokemon = [];

  async function fetchAllPokemon() {
    try {
      // 1. Pega todos os nomes e URLs dos Pokémon
      const response = await fetch('https://pokeapi.co/api/v2/pokemon?limit=10000');
      const data = await response.json();
      const pokemonList = data.results;

      // 2. Busca detalhes de todos os Pokémon com controle de concorrência
      const batchSize = 20; // número de requisições simultâneas
      for (let i = 0; i < pokemonList.length; i += batchSize) {
        const batch = pokemonList.slice(i, i + batchSize);
        const promises = batch.map(p => fetch(p.url).then(res => res.json()));
        const batchData = await Promise.all(promises);
        allPokemon.push(...batchData);
        displayPokemon(allPokemon); // opcional: exibe progressivamente
      }

    } catch (error) {
      console.error("Erro ao buscar todos os Pokémon:", error);
    }
  }

  function displayPokemon(pokemonList) {
    pokedexContainer.innerHTML = '';
    pokemonList.forEach(pokemon => {
      const card = document.createElement('div');
      card.classList.add('pokemon-card');
      card.innerHTML = `
        <h3>#${pokemon.id} ${capitalize(pokemon.name)}</h3>
        <img src="${pokemon.sprites.front_default}" class="pokemon-img" onclick="rotatePokemon(event)">
        <p>Tipo: ${pokemon.types.map(t => capitalize(t.type.name)).join(', ')}</p>
      `;
      card.addEventListener('click', () => showDetails(pokemon));
      pokedexContainer.appendChild(card);
    });
  }

  function rotatePokemon(event) {
    event.stopPropagation();
    const imgElement = event.target;
    imgElement.classList.add('rotate');
    setTimeout(() => imgElement.classList.remove('rotate'), 1000);
  }

  function searchPokemon() {
    const query = searchInput.value.trim().toLowerCase();
    const filtered = allPokemon.filter(p =>
      p.name.includes(query) || p.id.toString() === query
    );
    displayPokemon(filtered);
  }

  function filterByType() {
    const type = typeFilter.value;
    if (!type) return displayPokemon(allPokemon);
    const filtered = allPokemon.filter(p =>
      p.types.some(t => t.type.name === type)
    );
    displayPokemon(filtered);
  }

  function showDetails(pokemon) {
    document.getElementById('modalTitle').innerText = `${pokemon.name.toUpperCase()} (#${pokemon.id})`;
    document.getElementById('modalDetails').innerHTML = `
      <strong>Peso:</strong> ${pokemon.weight / 10}kg<br>
      <strong>Altura:</strong> ${pokemon.height / 10}m<br>
      <strong>Tipo:</strong> ${pokemon.types.map(t => capitalize(t.type.name)).join(', ')}<br>
      <strong>Habilidades:</strong> ${pokemon.abilities.map(a => capitalize(a.ability.name)).join(', ')}
    `;
    document.getElementById('pokemonModal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('pokemonModal').style.display = 'none';
  }

  window.onclick = function(event) {
    const modal = document.getElementById('pokemonModal');
    if (event.target === modal) closeModal();
  }

  function capitalize(text) {
    return text.charAt(0).toUpperCase() + text.slice(1);
  }

  fetchAllPokemon();
</script>
