<script>
  const pokedexContainer = document.getElementById('pokedex');
  const searchInput = document.getElementById('searchInput');
  const typeFilter = document.getElementById('typeFilter');
  let allPokemon = [];
  let displayedCount = 0;
  const batchSize = 100;
  let filteredPokemon = null; // Para guardar filtro atual (busca ou tipo)

  async function fetchPokemonBatch(start, end) {
    // Busca detalhes dos pokémon do intervalo [start, end]
    const promises = [];
    for(let i = start; i <= end; i++) {
      promises.push(fetch(`https://pokeapi.co/api/v2/pokemon/${i}`).then(res => res.json()));
    }
    return Promise.all(promises);
  }

  async function fetchPokemon() {
    try {
      // Gerações 1 a 3: pokémon #1 ao #386
      allPokemon = [];
      for(let i = 1; i <= 386; i += 50) {
        // Buscar em lotes de 50 para não travar a página
        const batchEnd = Math.min(i + 49, 386);
        const batchData = await fetchPokemonBatch(i, batchEnd);
        allPokemon.push(...batchData);
        if(displayedCount === 0) {
          displayedCount = batchSize;
          displayPokemon(allPokemon.slice(0, displayedCount));
          showLoadMoreButton();
        }
      }
    } catch (error) {
      console.error("Erro ao buscar Pokémon:", error);
    }
  }

  function displayPokemon(pokemonList) {
    pokedexContainer.innerHTML = '';
    pokemonList.forEach(pokemon => appendPokemonCard(pokemon));
  }

  function appendPokemonCard(pokemon) {
    const card = document.createElement('div');
    card.classList.add('pokemon-card');
    card.innerHTML = `
      <h3>#${pokemon.id} ${capitalize(pokemon.name)}</h3>
      <img src="${pokemon.sprites.front_default}" class="pokemon-img" onclick="rotatePokemon(event)">
      <p>Tipo: ${pokemon.types.map(t => capitalize(t.type.name)).join(', ')}</p>
    `;
    card.addEventListener('click', () => showDetails(pokemon));
    pokedexContainer.appendChild(card);
  }

  function rotatePokemon(event) {
    event.stopPropagation();
    const imgElement = event.target;
    imgElement.classList.add('rotate');
    setTimeout(() => imgElement.classList.remove('rotate'), 1000);
  }

  function searchPokemon() {
    const query = searchInput.value.trim().toLowerCase();
    filteredPokemon = allPokemon.filter(p =>
      p.name.includes(query) || p.id.toString() === query
    );
    displayedCount = filteredPokemon.length;
    document.getElementById('loadMoreButton')?.remove();
    displayPokemon(filteredPokemon);
  }

  function filterByType() {
    const type = typeFilter.value;
    if (!type) {
      filteredPokemon = null;
      displayedCount = batchSize;
      displayPokemon(allPokemon.slice(0, displayedCount));
      showLoadMoreButton();
      return;
    }
    filteredPokemon = allPokemon.filter(p =>
      p.types.some(t => t.type.name === type)
    );
    displayedCount = filteredPokemon.length;
    document.getElementById('loadMoreButton')?.remove();
    displayPokemon(filteredPokemon);
  }

  function showDetails(pokemon) {
    document.getElementById('modalTitle').innerText = `${pokemon.name.toUpperCase()} (#${pokemon.id})`;
    document.getElementById('modalDetails').innerHTML = `
      <strong>Peso:</strong> ${pokemon.weight / 10}kg<br>
      <strong>Altura:</strong> ${pokemon.height / 10}m<br>
      <strong>Tipo:</strong> ${pokemon.types.map(t => capitalize(t.type.name)).join(', ')}<br>
      <strong>Habilidades:</strong> ${pokemon.abilities.map(a => capitalize(a.ability.name)).join(', ')}
    `;
    document.getElementById('pokemonModal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('pokemonModal').style.display = 'none';
  }

  function capitalize(text) {
    return text.charAt(0).toUpperCase() + text.slice(1);
  }

  function showLoadMoreButton() {
    let button = document.getElementById('loadMoreButton');
    if (!button) {
      button = document.createElement('button');
      button.id = 'loadMoreButton';
      button.innerText = 'Carregar mais';
      button.style.margin = '20px';
      button.onclick = loadMorePokemon;
      document.body.appendChild(button);
    }
  }

  function loadMorePokemon() {
    let listToShow = filteredPokemon || allPokemon;
    const nextBatch = listToShow.slice(displayedCount, displayedCount + batchSize);
    nextBatch.forEach(pokemon => appendPokemonCard(pokemon));
    displayedCount += batchSize;
    if (displayedCount >= listToShow.length) {
      document.getElementById('loadMoreButton')?.remove();
    }
  }

  window.onclick = function(event) {
    const modal = document.getElementById('pokemonModal');
    if (event.target === modal) {
      closeModal();
    }
  }

  fetchPokemon();
</script>
